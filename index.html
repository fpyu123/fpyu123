<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Realityè‡ªåˆ¶å·¥å…·</title>
  <style>
    :root {
      --fg: #2f3440; --bg: #f6f7f9; --card: #fff; --primary: #3a3f51; --border: #e3e6eb; --muted:#666;
    }
    .dark { --fg:#eaeef3; --bg:#0e1217; --card:#12161c; --primary:#4c89ff; --border:#263041; --muted:#9aa7b2; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans SC', sans-serif; color: var(--fg); background: var(--bg); }
    .wrap { max-width: 980px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 24px; margin: 0 0 8px; color: var(--fg); }
    .sub { color: var(--muted); margin-bottom: 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.05); }
    .toolbar { display: flex; justify-content: space-between; gap: 8px; padding: 12px; border-bottom: 1px solid var(--border); }
    .btns { display:flex; gap:8px; }
    button { appearance: none; border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; cursor: pointer; background: #f7f9fb; color: #333; }
    .dark button { background:#1c2330; color:#eaeef3; border-color: var(--border); }
    button.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    button:active { transform: translateY(1px); }
    .body { padding: 0; }
    textarea { width: 100%; height: 220px; border: none; padding: 14px; resize: vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 13px; line-height: 1.6; background: #fafafa; border-radius: 0 0 10px 10px; }
    .dark textarea { background:#0f141b; color:#d9e2ec; }
    .row { display: flex; align-items: center; gap: 12px; padding: 12px; flex-wrap: wrap; }
    .row label { white-space: nowrap; color: var(--muted); }
    select, input[type="checkbox"] { padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; background: #fff; }
    .dark select { background:#0f141b; color:#d9e2ec; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; padding:12px; }
    .grid .box { border-top: 1px dashed var(--border); padding-top: 10px; }
    .hint { padding: 12px; color: var(--muted); font-size: 12px; border-top: 1px dashed var(--border); }
    .stat { margin-left:auto; color: var(--muted); font-size:12px; }
    .footer { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    pre { background: #f7f9fb; border: 1px solid var(--border); border-radius: 10px; padding: 12px; overflow: auto; }
    .dark pre { background:#0f141b; color:#d9e2ec; border-color: var(--border); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Realityç›®æ ‡åŸŸå</h1>
    <div class="sub">æ‰©å±•åŸŸåæ± ã€å»é‡å¤ã€å¯è‡ªå®šä¹‰ä¸å›ºå®šã€æ”¯æŒå¯¼å‡º/æš—è‰²æ¨¡å¼ã€‚</div>
    <div class="card">
      <div class="toolbar">
        <div class="btns">
          <button id="btnShuffle">æ¢ä¸€æ‰¹</button>
          <button id="btnCopy" class="primary">å¤åˆ¶</button>
          <button id="btnExportTxt">å¯¼å‡ºtxt</button>
          <button id="btnExportSh">å¯¼å‡ºsh</button>
          <button id="btnExportJson">å¯¼å‡ºjson</button>
        </div>
        <div>
          <label style="margin-right:8px"><input id="toggleDark" type="checkbox"> æš—è‰²æ¨¡å¼</label>
          <span class="stat" id="poolStat"></span>
        </div>
      </div>
      <div class="row">
        <label for="count">åŸŸåæ•°é‡</label>
        <select id="count">
          <option value="8">8</option>
          <option value="12" selected>12</option>
          <option value="16">16</option>
          <option value="20">20</option>
          <option value="30">30</option>
        </select>
        <label for="fmt">è¾“å‡ºæ ¼å¼</label>
        <select id="fmt">
          <option value="bash" selected>bashæ£€æŸ¥è„šæœ¬</option>
          <option value="list">ä»…åŸŸååˆ—è¡¨</option>
          <option value="latency_issuer">bashæ—¶å»¶+è¯ä¹¦é¢å‘è€…ï¼ˆç¤ºä¾‹æ ·å¼ï¼‰</option>
          <option value="latency">ä»…æ—¶å»¶ï¼ˆdomain: msï¼‰</option>
        </select>
        <label style="margin-left:12px"><input id="toggleExact" type="checkbox"> ç²¾ç¡®æ¨¡å¼ï¼ˆç¤ºä¾‹é›†åˆï¼‰</label>
        <label style="margin-left:12px">å›ºå®šç§å­ <input id="seed" type="text" placeholder="å¦‚ 42" style="width:100px"></label>
        <label style="margin-left:12px">ç›®æ ‡æ—¶å»¶(ms) <input id="threshold" type="number" min="0" step="1" value="200" style="width:100px"></label>
      </div>
      <div class="body">
        <textarea id="scriptText" readonly></textarea>
      </div>
      <div class="box" style="padding:12px; border-top:1px dashed var(--border);">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px; flex-wrap:wrap;">
          <strong>åŸŸååŒ…é€‰æ‹©</strong>
          <span style="color:var(--muted);font-size:12px;">æŒ‰ç±»åˆ«å‹¾é€‰åˆå¹¶ï¼ˆè‡ªåŠ¨å»é‡ï¼ŒæŒä¹…åŒ–ï¼‰</span>
          <span style="flex:1"></span>
          <button id="btnPacksAll">å…¨é€‰</button>
          <button id="btnPacksNone">æ¸…ç©º</button>
        </div>
        <div id="packList" style="display:grid;grid-template-columns: repeat(3,1fr); gap:8px;"></div>
      </div>
      <div class="grid">
        <div class="box">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
            <strong>è‡ªå®šä¹‰åŸŸåå¯¼å…¥</strong>
            <span style="color:var(--muted);font-size:12px;">æ”¯æŒé€—å·/ç©ºæ ¼/æ¢è¡Œåˆ†éš”</span>
          </div>
          <textarea id="customText" placeholder="ç²˜è´´ä½ çš„åŸŸååˆ—è¡¨..."></textarea>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="btnApplyCustom">åº”ç”¨å¹¶åˆå¹¶</button>
            <button id="btnClearCustom">æ¸…ç©ºè‡ªå®šä¹‰</button>
          </div>
        </div>
        <div class="box">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
            <strong>å›ºå®šä¿ç•™åŸŸå</strong>
            <span style="color:var(--muted);font-size:12px;">ç”Ÿæˆæ—¶å¿…åŒ…å«ï¼Œè¶…å‡ºæ•°é‡åˆ™å–å‰Nä¸ª</span>
          </div>
          <textarea id="fixedText" placeholder="ä¾‹å¦‚ï¼šwww.apple.com\nfonts.gstatic.com"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="btnApplyFixed">åº”ç”¨å›ºå®š</button>
            <button id="btnClearFixed">æ¸…ç©ºå›ºå®š</button>
          </div>
        </div>
      </div>
      <div class="hint">
        - ç”Ÿæˆæ—¶è‡ªåŠ¨å»é‡ä¸è§„èŒƒåŒ–åŸŸåï¼›æ± åŒ…å«å†…ç½®+è‡ªå®šä¹‰ã€‚<br>
        - å¤åˆ¶/å¯¼å‡ºå‡åŸºäºå½“å‰æ˜¾ç¤ºå†…å®¹ï¼›è®¾ç½®ä¼šæŒä¹…åŒ–ä¿å­˜åœ¨æµè§ˆå™¨ã€‚<br>
        - æœ¬é¡µçº¯å‰ç«¯ï¼Œæ— éœ€å¤–ç½‘ä¾èµ–ï¼Œå¯æœ¬åœ°ç¦»çº¿è¿è¡Œã€‚
      </div>
    </div>
  </div>

<script>
  // â€”â€” åŸºç¡€åŸŸåæ± ï¼ˆæ‰©å±•ç‰ˆï¼Œç²¾é€‰å¸¸è§ CDN/å¤§ç«™/äº‘æœåŠ¡ï¼‰ â€”â€”
  const BASE_POOL = [
    // Microsoft / Xbox
    'go.microsoft.com','www.microsoft.com','login.microsoftonline.com','acctcdn.msftauth.net','store-images.s-microsoft.com','www.xbox.com','xboxlive.com',
    // Apple / iTunes / iCloud
    'www.apple.com','support.apple.com','init.itunes.apple.com','se-edge.itunes.apple.com','isl-ssl.mzstatic.com','api.apple-cloudkit.com','itunes.apple.com','cdn.apple-cloudkit.com',
    // Google / YouTube / Fonts / Gstatic
    'www.google.com','google.com','apis.google.com','ajax.googleapis.com','fonts.googleapis.com','fonts.gstatic.com','www.gstatic.com','www.youtube.com','i.ytimg.com','yt3.ggpht.com',
    // Cloudflare
    'cdn.cloudflare.net','static.cloudflareinsights.com','cloudflare.com','cdnjs.cloudflare.com',
    // GitHub
    'github.com','raw.githubusercontent.com','githubusercontent.com',
    // Amazon / AWS / CloudFront
    'aws.amazon.com','cloudfront.net','images-na.ssl-images-amazon.com','s3.amazonaws.com',
    // Telegram
    'api.telegram.org','telegram.org','t.me',
    // Akamai / Fastly / EdgeCast
    'akamaihd.net','akamaized.net','fastly.net','edgecastcdn.net',
    // Meta / Twitter / Reddit
    'facebook.com','fbcdn.net','instagram.com','cdninstagram.com','x.com','twitter.com','t.co','reddit.com','redd.it','redditmedia.com',
    // Streaming / Media
    'netflix.com','nflximg.net','spotify.com','api.spotify.com','soundcloud.com','scdn.co',
    // Dev / Docs
    'stackoverflow.com','stackexchange.com','cdn.sstatic.net','developer.mozilla.org','wikipedia.org','wikimedia.org',
    // Othersï¼ˆä¿æŒå›½é™…åŸŸåï¼Œä¸å«å›½å†…ï¼‰
    'quic.cloud','cdn77.org','cdn77.api.userway.org','downloadmirror.intel.com','d.impactradius-event.com','consent.trustarc.com','bitbucket.org','gitlab.com','vercel.com','cdn.vercel-insights.com','netlify.com','netlify.app','digitalocean.com','digitaloceanspaces.com','linode.com','oracle.com','oraclecloud.com','dropbox.com','dl.dropboxusercontent.com','box.com','onedrive.live.com','zoom.us','slack.com','notion.so','figma.com','openai.com','huggingface.co','cdn.huggingface.co','stripe.com','js.stripe.com','paypal.com','cdn.paypal.com','shopify.com','cdn.shopify.com','steampowered.com','steamcommunity.com','steamstatic.com','playstation.com','sonyentertainmentnetwork.com','epicgames.com','cdn1.epicgames.com'
  ];

  // â€”â€” ç¤ºä¾‹é›†åˆï¼ˆä¸æˆªå›¾ä¸€è‡´çš„åŸŸåé¡ºåºï¼‰ â€”â€”
  const EXACT_PRESET = [
    'go.microsoft.com','acctcdn.msftauth.net','se-edge.itunes.apple.com','isl-ssl.mzstatic.com','consent.trustarc.com','d.impactradius-event.com','cdn77.api.userway.org','www.xbox.com','store-images.s-microsoft.com','downloadmirror.intel.com'
  ];

  // â€”â€” æ‰©å±•åŸŸååŒ…ï¼ˆåˆ†ç±»ï¼‰ â€”â€”
  const PACKS = [
    { key:'ms', name:'Microsoft/Windows/Xbox', domains:[
      'microsoft.com','www.microsoft.com','aka.ms','live.com','outlook.com','office.com','windows.com','windowsupdate.com','msauth.net','msftauth.net','visualstudio.com','azureedge.net','edgesuite.net','xbox.com','xboxlive.com','bing.com','skype.com'
    ]},
    { key:'apple', name:'Apple/iTunes/iCloud', domains:[
      'apple.com','www.apple.com','developer.apple.com','cdn.apple-cloudkit.com','icloud.com','itunes.apple.com','mzstatic.com','aod.itunes.apple.com','updates-http.cdn-apple.com'
    ]},
    { key:'google', name:'Google/YouTube/Gstatic', domains:[
      'google.com','www.google.com','accounts.google.com','apis.google.com','ajax.googleapis.com','googleapis.com','storage.googleapis.com','dl.google.com','gstatic.com','fonts.googleapis.com','fonts.gstatic.com','www.gstatic.com','youtube.com','www.youtube.com','youtu.be','i.ytimg.com','yt3.ggpht.com'
    ]},
    { key:'cloudflare', name:'Cloudflare/CDNJS', domains:[
      'cloudflare.com','cdn.cloudflare.net','cloudflareinsights.com','static.cloudflareinsights.com','cdnjs.cloudflare.com','cf-ipfs.com'
    ]},
    { key:'github', name:'GitHub/Gist', domains:[
      'github.com','gist.github.com','raw.githubusercontent.com','githubusercontent.com','avatars.githubusercontent.com','codeload.github.com'
    ]},
    { key:'aws', name:'Amazon/AWS/CloudFront/S3', domains:[
      'amazon.com','aws.amazon.com','cloudfront.net','s3.amazonaws.com','s3.us-east-1.amazonaws.com','s3-us-west-1.amazonaws.com','awsstatic.com'
    ]},
    { key:'telegram', name:'Telegram', domains:[
      't.me','telegram.org','api.telegram.org','tg.dev'
    ]},
    { key:'cdn', name:'CDN/Akamai/Fastly/EdgeCast', domains:[
      'akamaihd.net','akamaized.net','edgekey.net','edgesuite.net','fastly.net','cdnfastly.com','edgecastcdn.net','quic.cloud','jsdelivr.net','unpkg.com','staticfile.org'
    ]},
    { key:'social', name:'Meta/Twitter/Reddit', domains:[
      'facebook.com','fbcdn.net','instagram.com','cdninstagram.com','whatsapp.com','x.com','twitter.com','t.co','reddit.com','redd.it','redditmedia.com'
    ]},
    { key:'stream', name:'Streaming/Media', domains:[
      'netflix.com','nflximg.net','nflxvideo.net','hulu.com','spotify.com','api.spotify.com','scdn.co','soundcloud.com'
    ]},
    { key:'dev', name:'Dev/Docs', domains:[
      'stack Overflow.com'.toLowerCase(),'stackexchange.com','cdn.sstatic.net','developer.mozilla.org','mozilla.org','w3.org','w3schools.com','pkg.go.dev','pypi.org','files.pythonhosted.org','rubygems.org','registry.npmjs.org','npmjs.com','yarnpkg.com'
    ]},
    // æ‰©å±•ï¼šå›½é™…äº‘/éƒ¨ç½²å¹³å°
    { key:'cloud2', name:'Vercel/Netlify/DO/Linode/Oracle', domains:[
      'vercel.com','vercel-insights.com','cdn.vercel-insights.com','netlify.com','netlify.app','digitalocean.com','digitaloceanspaces.com','linode.com','linodeusercontent.com','oracle.com','oraclecloud.com'
    ]},
    // æ‰©å±•ï¼šåä½œ/ç”Ÿäº§åŠ›
    { key:'collab', name:'Slack/Zoom/Notion/Figma/Atlassian', domains:[
      'slack.com','zoom.us','notion.so','figma.com','atlassian.com','bitbucket.org','jira.atlassian.com','confluence.atlassian.com'
    ]},
    // æ‰©å±•ï¼šä»£ç å¹³å°
    { key:'dev2', name:'GitLab/Skypack/Deno', domains:[
      'gitlab.com','gitlab-static.net','cdn.skypack.dev','deno.land','deno.com'
    ]},
    // æ‰©å±•ï¼šæ”¯ä»˜/ç”µå•†
    { key:'payments', name:'Stripe/PayPal/Shopify', domains:[
      'stripe.com','js.stripe.com','paypal.com','cdn.paypal.com','shopify.com','cdn.shopify.com'
    ]},
    // æ‰©å±•ï¼šAI/ML
    { key:'ai', name:'OpenAI/HuggingFace/Replicate', domains:[
      'openai.com','huggingface.co','cdn.huggingface.co','replicate.com','anthropic.com'
    ]},
    // æ‰©å±•ï¼šæ¸¸æˆ/å¨±ä¹
    { key:'gaming', name:'Steam/PlayStation/Epic', domains:[
      'steampowered.com','steamcommunity.com','steamstatic.com','playstation.com','sonyentertainmentnetwork.com','epicgames.com','cdn1.epicgames.com'
    ]}
  ];

  // â€”â€” å·¥å…·ä¸çŠ¶æ€ â€”â€”
  const LS_KEY = 'reality.settings.v1';
  let customSet = new Set();
  let fixedSet = new Set();
  let selectedPacks = new Set();

  const domainRegex = /^(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+[a-z]{2,}$/; // ç®€æ˜“æ ¡éªŒ

  function normalizeDomain(d) {
    if (!d) return '';
    let s = String(d).trim().toLowerCase();
    s = s.replace(/^https?:\/\//,'');
    s = s.split('/')[0].split('?')[0].split('#')[0];
    s = s.replace(/:\d+$/,'');
    return s.replace(/\.$/,'');
  }

  function parseInput(text) {
    const parts = String(text||'').split(/\s|,|;|\n|\r/).map(normalizeDomain).filter(Boolean);
    return parts.filter(d => domainRegex.test(d));
  }

  function buildPool() {
    const pool = new Set();
    BASE_POOL.forEach(d => pool.add(normalizeDomain(d)));
    // é€‰ä¸­çš„åŒ…
    PACKS.forEach(p => { if (selectedPacks.has(p.key)) p.domains.forEach(d => pool.add(normalizeDomain(d))); });
    customSet.forEach(d => pool.add(d));
    return [...pool];
  }

  function pickRandomWithFixed(count, seed) {
    const fixed = [...fixedSet];
    const pool = buildPool().filter(d => !fixedSet.has(d));
    // éšæœºæ´—ç‰Œï¼ˆæ”¯æŒå›ºå®šç§å­ï¼‰
    const shuffled = (typeof shuffleSeeded === 'function')
      ? shuffleSeeded(pool, seed)
      : [...pool].sort(() => Math.random() - 0.5);
    const take = Math.max(0, count - fixed.length);
    const selection = fixed.slice(0, count).concat(shuffled.slice(0, take));
    // æœ€ç»ˆå†å»é‡
    return [...new Set(selection)].slice(0, count);
  }

  function buildBash(domains) {
    const list = domains.join(' ');
    return `for d in ${list} ; do t1=$(date +%s%3N); timeout 1 openssl s_client -connect "$d:443" -servername "$d" < /dev/null 2>/dev/null | sed -n "/issuer/ {s/.*CN = //; p}" ; done`;
  }
  function buildList(domains) { return domains.join('\n'); }

  // ä¸æˆªå›¾ä¸€è‡´ï¼šå…ˆæµ‹æ¡æ‰‹æ—¶å»¶ï¼Œå†æ‰“å°è¯ä¹¦é“¾é¢å‘è€… CN
  function buildBashLatencyIssuer(domains, thr) {
    const list = domains.join(' ');
    const loop1 = `for d in ${list} ; do t1=$(date +%s%3N); if timeout 2 openssl s_client -connect "$d:443" -servername "$d" < /dev/null >/dev/null 2>&1 ; then t2=$(date +%s%3N); dur=$((t2 - t1)); if [ $dur -lt ${thr} ]; then echo "$d: \${dur} ms"; fi; fi; done`;
    const loop2 = `for d in ${list} ; do timeout 2 openssl s_client -connect "$d:443" -servername "$d" < /dev/null 2>/dev/null | sed -n "/issuer/ {s/.*CN = //; p}" ; done`;
    return loop1 + "\n\n" + loop2;
  }

  // ä»…æ—¶å»¶ï¼ˆæ— è®ºæˆåŠŸä¸å¦éƒ½è®¡ç®—è€—æ—¶ï¼‰
  function buildBashLatency(domains, thr) {
    const list = domains.join(' ');
    return `for d in ${list} ; do t1=$(date +%s%3N); if timeout 2 openssl s_client -connect "$d:443" -servername "$d" < /dev/null >/dev/null 2>&1 ; then t2=$(date +%s%3N); dur=$((t2 - t1)); if [ $dur -lt ${thr} ]; then echo "$d: \${dur} ms"; fi; fi; done`;
  }

  function render() {
    const count = parseInt(document.getElementById('count').value, 10);
    const fmt = document.getElementById('fmt').value;
    const seed = document.getElementById('seed').value.trim();
    const thr = parseInt(document.getElementById('threshold').value, 10) || 200;
    const useExact = document.getElementById('toggleExact').checked;
    const domains = useExact ? [...EXACT_PRESET] : pickRandomWithFixed(count, seed);
    let text = '';
    if (fmt === 'bash') text = buildBash(domains);
    else if (fmt === 'list') text = buildList(domains);
    else if (fmt === 'latency_issuer') text = buildBashLatencyIssuer(domains, thr);
    else if (fmt === 'latency') text = buildBashLatency(domains, thr);
    document.getElementById('scriptText').value = text;
    const extra = useExact ? ` Â· ç²¾ç¡®æ¨¡å¼ï¼š${EXACT_PRESET.length}ä¸ª` : (seed ? ` Â· ç§å­ï¼š${seed}` : '');
    document.getElementById('poolStat').textContent = `åŸŸåæ± ï¼š${buildPool().length} ä¸ªï¼ˆå«å»é‡ï¼ŒåŒ…${selectedPacks.size}/${PACKS.length}ï¼‰${extra}`;
    saveSettings();
  }

  async function copyText() {
    const el = document.getElementById('scriptText');
    const text = el.value;
    try { await navigator.clipboard.writeText(text); toast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'); }
    catch { el.select(); document.execCommand('copy'); toast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'); }
  }

  function exportFile(type) {
    const count = parseInt(document.getElementById('count').value, 10);
    const fmt = document.getElementById('fmt').value;
    const domains = pickRandomWithFixed(count);
    let name = `reality_domains_${Date.now()}.${type}`;
    let content = '';
    if (type === 'txt') content = buildList(domains);
    if (type === 'sh') content = buildBash(domains);
    if (type === 'json') content = JSON.stringify({ domains, format: fmt, generatedAt: new Date().toISOString() }, null, 2);
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = name; a.click(); URL.revokeObjectURL(url);
    toast('å·²å¯¼å‡º ' + name);
  }

  function toast(msg) {
    const tip = document.createElement('div');
    tip.textContent = msg;
    Object.assign(tip.style, { position:'fixed', left:'50%', top:'20px', transform:'translateX(-50%)', background:'#333', color:'#fff', padding:'8px 12px', borderRadius:'6px', fontSize:'12px', zIndex:9999, boxShadow:'0 6px 18px rgba(0,0,0,.15)' });
    document.body.appendChild(tip);
    setTimeout(() => tip.remove(), 1600);
  }

  function applyCustom() {
    const list = parseInput(document.getElementById('customText').value);
    customSet = new Set(list);
    toast(`å·²åº”ç”¨è‡ªå®šä¹‰ ${customSet.size} ä¸ª`);
    render();
  }
  function clearCustom() { customSet.clear(); document.getElementById('customText').value=''; render(); }

  function applyFixed() {
    const list = parseInput(document.getElementById('fixedText').value);
    fixedSet = new Set(list);
    toast(`å·²è®¾ç½®å›ºå®š ${fixedSet.size} ä¸ª`);
    render();
  }
  function clearFixed() { fixedSet.clear(); document.getElementById('fixedText').value=''; render(); }

  function saveSettings() {
    const settings = {
      count: document.getElementById('count').value,
      fmt: document.getElementById('fmt').value,
      dark: document.getElementById('toggleDark').checked,
      customText: document.getElementById('customText').value,
      fixedText: document.getElementById('fixedText').value,
      selectedPacks: [...selectedPacks],
      exact: document.getElementById('toggleExact').checked,
      seed: document.getElementById('seed').value,
      threshold: document.getElementById('threshold').value,
    };
    try { localStorage.setItem(LS_KEY, JSON.stringify(settings)); } catch {}
  }
  function loadSettings() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const s = JSON.parse(raw);
      document.getElementById('count').value = s.count || '12';
      document.getElementById('fmt').value = s.fmt || 'bash';
      document.getElementById('toggleDark').checked = !!s.dark;
      if (s.dark) document.body.classList.add('dark');
      document.getElementById('customText').value = s.customText || '';
      document.getElementById('fixedText').value = s.fixedText || '';
      customSet = new Set(parseInput(s.customText));
      fixedSet = new Set(parseInput(s.fixedText));
      selectedPacks = new Set((s.selectedPacks||[]).filter(k => PACKS.some(p => p.key===k)));
      document.getElementById('toggleExact').checked = !!s.exact;
      document.getElementById('seed').value = s.seed || '';
      document.getElementById('threshold').value = s.threshold || '200';
    } catch {}
  }

  function toggleDarkMode() {
    const on = document.getElementById('toggleDark').checked;
    document.body.classList.toggle('dark', on);
    saveSettings();
  }

  // â€”â€” åŠ¨æ€ç”ŸæˆåŒ…é€‰æ‹© UI â€”â€”
  function renderPackList() {
    const box = document.getElementById('packList');
    box.innerHTML = '';
    PACKS.forEach(p => {
      const id = 'pack_'+p.key;
      const label = document.createElement('label');
      label.style.display = 'flex';
      label.style.alignItems = 'center';
      label.style.gap = '8px';
      label.style.padding = '6px 8px';
      label.style.border = '1px solid var(--border)';
      label.style.borderRadius = '6px';
      label.style.background = 'var(--card)';
      label.innerHTML = `<input type="checkbox" id="${id}"> <span>${p.name}</span>`;
      box.appendChild(label);
      const cb = label.querySelector('input');
      cb.checked = selectedPacks.has(p.key);
      cb.addEventListener('change', () => { if(cb.checked) selectedPacks.add(p.key); else selectedPacks.delete(p.key); render(); });
    });
  }
  function packsAll() { selectedPacks = new Set(PACKS.map(p=>p.key)); renderPackList(); render(); }
  function packsNone() { selectedPacks.clear(); renderPackList(); render(); }

  document.getElementById('btnShuffle').addEventListener('click', render);
  document.getElementById('btnCopy').addEventListener('click', copyText);
  document.getElementById('btnExportTxt').addEventListener('click', () => exportFile('txt'));
  document.getElementById('btnExportSh').addEventListener('click', () => exportFile('sh'));
  document.getElementById('btnExportJson').addEventListener('click', () => exportFile('json'));
  document.getElementById('btnApplyCustom').addEventListener('click', applyCustom);
  document.getElementById('btnClearCustom').addEventListener('click', clearCustom);
  document.getElementById('btnApplyFixed').addEventListener('click', applyFixed);
  document.getElementById('btnClearFixed').addEventListener('click', clearFixed);
  document.getElementById('count').addEventListener('change', render);
  document.getElementById('fmt').addEventListener('change', render);
  document.getElementById('toggleDark').addEventListener('change', toggleDarkMode);
  document.getElementById('toggleExact').addEventListener('change', render);
  document.getElementById('seed').addEventListener('input', () => { /*èŠ‚æµå¯é€‰*/ render(); });
  document.getElementById('threshold').addEventListener('input', render);
  document.getElementById('btnPacksAll').addEventListener('click', packsAll);
  document.getElementById('btnPacksNone').addEventListener('click', packsNone);

  document.addEventListener('DOMContentLoaded', () => { loadSettings(); renderPackList(); render(); });
</script>
  <div class="footer">
    <div class="card">
      <div class="toolbar"><strong>éƒ¨ç½²ä¸å®¢æˆ·ç«¯ä¸‹è½½</strong></div>
      <div style="padding:12px;">
        <div style="margin-bottom:10px; color:var(--muted);">è¤å…‰äº‘æœåŠ¡å™¨</div>
        <pre><code>https://console.ygcloud.com/login</code></pre>
        
        <div style="margin-bottom:10px; color:var(--muted);">è¿æ¥æœåŠ¡å™¨</div>
        <pre><code>ssh root@0.0.0.0 -p 22</code></pre>

        <div style="margin:16px 0 10px; color:var(--muted);">å®‰è£… S-UI</div>
        <pre><code>VERSION=1.2.2 && bash <(curl -Ls https://raw.githubusercontent.com/alireza0/s-ui/$VERSION/install.sh) $VERSION</code></pre>

        <div style="margin-bottom:10px; color:var(--muted);">å¸è½½ S-UI</div>
        <pre><code>sudo -i

systemctl disable s-ui  --now

rm -f /etc/systemd/system/sing-box.service
systemctl daemon-reload

rm -fr /usr/local/s-ui
rm /usr/bin/s-ui</code></pre>
        <div style="margin:16px 0 10px; color:var(--muted);">æ­é…S-UI</div>
        <pre><code>ç¬¬ä¸€æ­¥ï¼šTLSè®¾ç½®ï¼Œæ·»åŠ REALITYåç§°éšæ„ï¼Œï¼ŒSNIå’Œæ¡æ‰‹å¡«åŸŸåï¼Œç«¯å£443ï¼Œç”Ÿæˆå…¬é’¥ç§é’¥ï¼ŒTLSé€‰é¡¹å‹¾é€‰UTLSï¼Œéšä¾¿é€‰æ‹©ä¸€ä¸ªæµè§ˆå™¨ï¼Œä¿å­˜
ç¬¬äºŒæ­¥ï¼šTLSè®¾ç½®ï¼Œæ·»åŠ TLS,éšä¾¿ç»™ä¸ªåç§°ï¼Œç”Ÿæˆè¯ä¹¦å’Œç§é’¥ï¼Œå‹¾èµ·å…è®¸ä¸å®‰å…¨ï¼ŒTLSé€‰é¡¹å‹¾èµ·SNIå’ŒALPN,SNIå¡«å†™åŸŸåï¼Œä¿å­˜

ç¬¬ä¸‰æ­¥ï¼šå…¥ç«™ç®¡ç†ï¼Œæ·»åŠ ï¼Œç±»å‹VMessï¼Œæ ‡ç­¾éšæ„ï¼Œç«¯å£443ï¼Œæ¨¡ç‰ˆé€‰æ‹©æ·»åŠ REALITYçš„åç§°ï¼Œä¿å­˜
ç¬¬å››æ­¥ï¼šå…¥ç«™ç®¡ç†ï¼Œæ·»åŠ ï¼Œç±»å‹TUICï¼Œæ ‡ç­¾éšæ„ï¼Œç«¯å£443ï¼Œæ‹¥å¡æ§åˆ¶é€‰æ‹©bbrï¼Œæ¨¡ç‰ˆé€‰æ‹©æ·»åŠ TLSçš„åç§°ï¼Œä¿å­˜

ç¬¬äº”æ­¥ï¼šç”¨æˆ·ç®¡ç†ï¼Œå…¥ç«™æ ‡ç­¾ä¸¤ä¸ªéƒ½å‹¾èµ·æ¥ï¼Œå…¶ä»–ä¸ç”¨ï¼Œä¿å­˜</code></pre>
        <div style="margin-bottom:10px; color:var(--muted);">v2rayNä½¿ç”¨æ–¹æ³•</div>
        <pre><code>å·¦é”®å¤åˆ¶å³é”®ç²˜è´´ä¸¤ä¸ªäºŒç»´ç åˆ°v2rayNï¼Œåœ°å€IPå¯¹æœåŠ¡å™¨IPï¼ŒTUICè¦å°†è¯ä¹¦æ”¹æˆtrueï¼Œä¿å­˜
          æµ‹è¯•é…ç½®æ–‡ä»¶å»¶è¿Ÿï¼Œç³»ç»Ÿä»£ç†æ”¹è‡ªåŠ¨é…ç½®ç³»ç»Ÿä»£ç†ï¼Œè·¯ç”±ç»•è¿‡å¤§é™†</code></pre>
        <div style="margin:16px 0 10px; color:var(--muted);">ç­›é€‰åŸŸåé€‰æ‹©ä»…å»¶æ—¶</div>
        <div style="margin:16px 0 10px; color:var(--muted);">ä»£ç </div>
        <pre><code>ä»£ç ï¼š<div id="modal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4" onclick="closeModal()">
    <div class="bg-white rounded-[2rem] w-full max-w-5xl max-h-[90vh] overflow-hidden relative shadow-2xl flex flex-col md:flex-row" onclick="event.stopPropagation()">
        
        <div class="w-full md:w-1/2 bg-black flex flex-col h-[110vh] md:h-auto overflow-hidden relative">
            <div class="flex-grow overflow-hidden bg-black">
                <img id="m-img" src="" class="w-full h-full object-cover object-top transition-all duration-300">
            </div>
            
            <div id="m-album" class="grid grid-cols-4 gap-2 p-4 bg-[#222] border-t border-white/10 z-10">
                </div>
        </div>

        <div class="p-6 md:p-10 w-full md:w-1/2 flex flex-col relative overflow-y-auto bg-white">
            <div class="pr-16 md:pr-20"> 
                <h2 id="m-name" class="text-2xl md:text-3xl font-bold mb-2"></h2>
                <div id="m-tag" class="text-pink-500 font-bold text-xs md:text-sm mb-4"></div>
                <p id="m-bio" class="text-slate-500 text-sm leading-relaxed mb-6"></p>
            </div>

            <div class="fixed md:absolute right-0 top-[80%] -translate-y-1/2 z-30">
                <a id="m-link" href="#" target="_blank" 
                   class="block bg-pink-500 text-white py-10 px-3 rounded-l-2xl font-bold shadow-xl hover:bg-pink-600 transition-all [writing-mode:vertical-rl] tracking-[0.5em] text-lg">
                    ç«‹å³é¢„çº¦
                </a>
            </div>
        </div>

        <button onclick="closeModal()" class="absolute top-4 left-4 bg-black/20 backdrop-blur-md rounded-full w-8 h-8 text-white font-bold z-40">âœ•</button>
    </div>
</div>
        
        JS:async function openModal(index) {
    const u = allUsers[index];
    if (!u) return;

    // 1. è·å–å›¾ç‰‡æ ‡ç­¾å¹¶èµ‹å€¼ (å…³é”®ï¼šç¡®ä¿ ID ä¸ HTML å¯¹åº”)
    const mainImg = document.getElementById('m-img');
    if (mainImg) {
        mainImg.src = u.avatar; // èµ‹å€¼å¤´åƒè·¯å¾„
    }

    // 2. èµ‹å€¼æ–‡å­—ä¿¡æ¯
    document.getElementById('m-name').innerText = `${u.name}, ${u.age}`;
    document.getElementById('m-tag').innerText = `ğŸ“ ${u.province}-${u.city}-${u.district} Â· ${u.height}cm`;
    document.getElementById('m-bio').innerText = u.bio || 'æ­¤äººå¾ˆé—²ï¼Œä»€ä¹ˆéƒ½æ²¡å†™...';
    
    // 3. å¼‚æ­¥è·å–é¢„çº¦é“¾æ¥
    try {
        const sRes = await fetch('/api.php?action=get_setting&key=booking_url');
        const sData = await sRes.json();
        document.getElementById('m-link').href = sData.value || "#";
    } catch (e) { console.error(e); }

    // 4. æ¸²æŸ“å°å›¾ç›¸å†Œ
    const album = JSON.parse(u.images || '[]');
    const albumContainer = document.getElementById('m-album');
    if (albumContainer) {
        albumContainer.innerHTML = album.map(img => `
            <img src="${img}" 
                 class="h-14 w-full object-cover rounded-lg border border-white/20 cursor-pointer hover:border-pink-500 transition-all" 
                 onclick="document.getElementById('m-img').src='${img}'">
        `).join('');
    }
    
    document.getElementById('modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden'; 
}</code></pre>

        <div style="margin:16px 0 8px; color:var(--muted);">å®¢æˆ·ç«¯ä¸‹è½½</div>
        <ul style="margin:0; padding-left:18px; line-height:1.8;">
          <li>ç”µè„‘ç«¯ Windows/Macï¼ˆv2rayNï¼‰ï¼š<a href="https://github.com/2dust/v2rayN/releases/tag/7.12.7" target="_blank" rel="noopener noreferrer">https://github.com/2dust/v2rayN/releases/tag/7.12.7</a></li>
          <li>å®‰å“ Androidï¼ˆNekoBoxï¼‰ï¼š<a href="https://github.com/MatsuriDayo/NekoBoxForAndroid/releases/tag/1.3.9" target="_blank" rel="noopener noreferrer">https://github.com/MatsuriDayo/NekoBoxForAndroid/releases/tag/1.3.9</a></li>
          <li>è‹¹æœ iOS/Macï¼ˆShadowrocketï¼‰ï¼š<a href="https://apps.apple.com/app/shadowrocket/id932747118" target="_blank" rel="noopener noreferrer">https://apps.apple.com/app/shadowrocket/id932747118</a></li>
        </ul>
      </div>
    </div>
  </div>
</body>
</html>

